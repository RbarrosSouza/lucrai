<!-- a87d6812-371e-4cc3-833e-16ca9540e182 a5d3c2f1-0584-4204-a94d-f5fcfcce5451 -->
# Adicionar Grupo "Despesas Operacionais" na DRE

## Contexto

A estrutura DRE padrão precisa de um novo grupo raiz chamado **"Despesas Operacionais"** com duas contas lançáveis:

- Manutenção de Equipamentos
- Limpeza e Higienização

## Estrutura a ser criada

```
Despesas Operacionais (grupo raiz, sort_order=95)
├── 16.1 — Manutenção de Equipamentos
└── 16.2 — Limpeza e Higienização
```

**Posicionamento:** Entre "Gastos com Marketing" (sort_order=90) e "Receitas não Operacionais" (sort_order=100)

**Códigos utilizados:** Série 16.x (disponível, já que os códigos atuais vão até 15.x)

---

## Alterações Necessárias

### 1. Atualizar função `seed_default_dre` em `db/seed_default_dre.sql`

Adicionar no bloco de declaração:

```sql
grp_despesas_operacionais_id uuid;
```

Adicionar criação do grupo raiz (após "Gastos com Marketing", antes de "Receitas não Operacionais"):

```sql
-- [Despesas Operacionais]
select id into grp_despesas_operacionais_id
from public.categories
where org_id = _org_id and parent_id is null and name = 'Despesas Operacionais'
limit 1;
if grp_despesas_operacionais_id is null then
  insert into public.categories (org_id, name, type, is_active, include_in_dre, is_group, parent_id, sort_order, ext_code, sign_factor)
  values (_org_id, 'Despesas Operacionais', 'EXPENSE', true, true, true, null, 95, null, -1)
  returning id into grp_despesas_operacionais_id;
else
  update public.categories
  set type='EXPENSE', is_active=true, include_in_dre=true, is_group=true, parent_id=null, sort_order=95, ext_code=null, sign_factor=-1
  where id = grp_despesas_operacionais_id;
end if;
```

Adicionar contas lançáveis (após grupo "Gastos com Marketing" folhas):

```sql
-- [Despesas Operacionais]
select id into leaf_id from public.categories where org_id=_org_id and ext_code='16.1' limit 1;
if leaf_id is null then
  insert into public.categories (org_id, name, type, is_active, include_in_dre, is_group, parent_id, sort_order, ext_code, sign_factor)
  values (_org_id, 'Manutenção de Equipamentos', 'EXPENSE', true, true, false, grp_despesas_operacionais_id, 1601, '16.1', -1)
  returning id into leaf_id;
else
  update public.categories
  set name='Manutenção de Equipamentos', type='EXPENSE', is_active=true, include_in_dre=true, is_group=false, parent_id=grp_despesas_operacionais_id, sort_order=1601, sign_factor=-1
  where id=leaf_id;
end if;

select id into leaf_id from public.categories where org_id=_org_id and ext_code='16.2' limit 1;
if leaf_id is null then
  insert into public.categories (org_id, name, type, is_active, include_in_dre, is_group, parent_id, sort_order, ext_code, sign_factor)
  values (_org_id, 'Limpeza e Higienização', 'EXPENSE', true, true, false, grp_despesas_operacionais_id, 1602, '16.2', -1)
  returning id into leaf_id;
else
  update public.categories
  set name='Limpeza e Higienização', type='EXPENSE', is_active=true, include_in_dre=true, is_group=false, parent_id=grp_despesas_operacionais_id, sort_order=1602, sign_factor=-1
  where id=leaf_id;
end if;
```

### 2. Criar migration para organizações existentes

Arquivo: `db/migrations/2026-01-14_add_despesas_operacionais.sql`

A migration vai:

1. Recriar a função `seed_default_dre` atualizada
2. Executar `seed_default_dre` para todas as organizações existentes (como a função é idempotente, só adiciona o que falta)

---

## Resumo dos Arquivos

| Arquivo | Ação |

|---------|------|

| `db/seed_default_dre.sql` | Atualizar função com novo grupo e contas |

| `db/migrations/2026-01-14_add_despesas_operacionais.sql` | Nova migration para orgs existentes |

### To-dos

- [ ] Atualizar seed_default_dre.sql com grupo Despesas Operacionais e contas 16.1/16.2
- [ ] Criar migration para aplicar mudanças em organizações existentes
- [ ] Aplicar migration no Supabase via MCP